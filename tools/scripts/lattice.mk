################################################################################
# Lattice RISC-V RX platform integration                                       #
################################################################################

# Toolchain prefix (can be overridden by the user)
RISCV_PREFIX          ?= riscv-none-embed-

override AR           = $(RISCV_PREFIX)ar
override AS           = $(RISCV_PREFIX)gcc
override CC           = $(RISCV_PREFIX)gcc
override OC           = $(RISCV_PREFIX)objcopy
override SIZE         = $(RISCV_PREFIX)size
override OBJDUMP      = $(RISCV_PREFIX)objdump
override GDB          = $(RISCV_PREFIX)gdb
SREC_CAT              ?= srec_cat

################################################################################
#                      C library / specs selection                              #
################################################################################

LIBC ?= picolibc
ifeq ($(LIBC),newlib)
LIBC_SPECS   := --specs=nosys.specs
LIBC_DEFINES := -DNEWLIB
else ifeq ($(LIBC),newlib-nano)
LIBC_SPECS   := --specs=nano.specs
LIBC_DEFINES := -DNEWLIB_NANO
else ifeq ($(LIBC),picolibc)
LIBC_SPECS   := --specs=picolibc.specs
LIBC_DEFINES := -DPICOLIBC_DOUBLE_PRINTF_SCANF -DPICOLIBC
else
$(error Unsupported LIBC '$(LIBC)'; use newlib, newlib-nano or picolibc)
endif

################################################################################
#                            Compiler / Linker flags                            #
################################################################################

LATTICE_ARCH_FLAGS   ?= -march=rv32ima -mabi=ilp32 -msmall-data-limit=8 -mno-save-restore
LATTICE_DEBUG        ?= y
LATTICE_OPT_FLAGS    ?= -Os
ifeq (y,$(strip $(LATTICE_DEBUG)))
LATTICE_OPT_FLAGS := -O0 -g3
endif
LATTICE_COMMON_FLAGS ?= $(LATTICE_OPT_FLAGS) -fmessage-length=0 -fsigned-char \
	   -ffunction-sections -fdata-sections
LATTICE_DEFINES      ?= -DLATTICE_PLATFORM
LATTICE_CSTD         ?= -std=gnu11
LATTICE_ASFLAGS      ?= -x assembler-with-cpp
LATTICE_LDFLAGS      ?= -nostartfiles -Xlinker --gc-sections
LATTICE_MAP          ?= $(BUILD_DIR)/$(BINARY_FILE_NAME).map
LATTICE_LST          ?= $(BUILD_DIR)/$(BINARY_FILE_NAME).lst
LATTICE_SIZ          ?= $(BUILD_DIR)/$(BINARY_FILE_NAME).siz
LATTICE_BIN          ?= $(BUILD_DIR)/$(BINARY_FILE_NAME).bin
LATTICE_MEM          ?= $(BUILD_DIR)/$(BINARY_FILE_NAME).mem

CFLAGS  += $(LATTICE_ARCH_FLAGS) $(LATTICE_COMMON_FLAGS) $(LATTICE_CSTD) \
	   $(LATTICE_DEFINES) $(LIBC_DEFINES) $(LIBC_SPECS)
ASFLAGS += $(LATTICE_ARCH_FLAGS) $(LATTICE_COMMON_FLAGS) $(LATTICE_ASFLAGS) \
	   $(LATTICE_DEFINES) $(LIBC_DEFINES) $(LIBC_SPECS)
LDFLAGS += $(LATTICE_ARCH_FLAGS) $(LATTICE_COMMON_FLAGS) $(LATTICE_LDFLAGS) \
	   -Wl,-Map,$(LATTICE_MAP) $(LIBC_SPECS)

################################################################################
#                      Linker script (can be overridden)                        #
################################################################################

LATTICE_LINKER_SCRIPT ?= $(PROJECT)/src/platform/$(PLATFORM)/linker.ld
ifneq (,$(wildcard $(LATTICE_LINKER_SCRIPT)))
LSCRIPT ?= $(LATTICE_LINKER_SCRIPT)
endif

################################################################################
#                  Optional BSP sources pulled into the build                   #
################################################################################

# LATTICE_BSP_PATH can be a space-separated list of directories containing BSP
# sources (C/S) and headers generated by Propel. When not provided, fall back to
# $(PROJECT)/sge/bsp if it exists. These directories are appended to SRC_DIRS so
# generic.mk will automatically discover all source / header files beneath them.
LATTICE_BSP_PATH ?= $(PROJECT)/sge/bsp
LATTICE_SGE_ZIP ?= $(lastword $(filter %sge.zip,$(HARDWARE)))
LATTICE_SGE_DIR ?= $(PROJECT)/sge

ifneq (,$(wildcard $(LATTICE_BSP_PATH)))
BSP_DIRS := $(LATTICE_BSP_PATH)

else ifneq (,$(wildcard $(LATTICE_SGE_DIR)/bsp))
BSP_DIRS := $(LATTICE_SGE_DIR)/bsp

else ifneq (,$(wildcard $(LATTICE_SGE_ZIP)))
$(info [lattice] Extracting $(LATTICE_SGE_ZIP) into $(PROJECT))
$(shell unzip -oq "$(LATTICE_SGE_ZIP)" -d "$(PROJECT)")

ifneq (,$(wildcard $(LATTICE_SGE_DIR)/bsp))
BSP_DIRS := $(LATTICE_SGE_DIR)/bsp
else
$(error [lattice] Extracted archive did not provide $(LATTICE_SGE_DIR)/bsp)
endif

else
$(error [lattice] Missing BSP sources: set LATTICE_SGE_DIR or LATTICE_SGE_ZIP or provide $(LATTICE_SGE_DIR) or $(LATTICE_SGE_ZIP))
endif

ifneq ($(strip $(BSP_DIRS)),)
$(foreach bsp,$(BSP_DIRS),$(if $(wildcard $(bsp)),$(eval SRC_DIRS += $(bsp)),$(warning [lattice] Ignoring missing BSP directory '$(bsp)')))
endif

################################################################################
#                          Convenience platform targets                         #
################################################################################

.PHONY: lattice_run lattice_sdkbuild lattice_sdkclean lattice_sdkopen lattice_post_build
.PHONY: lattice_project

clean: lattice_clean

.PHONY: lattice_clean
lattice_clean:
	$(call print,[lattice] Removing build directory $(BUILD_DIR))
	$(call remove_dir,$(BUILD_DIR))

lattice_run:
	$(call print,lattice_run is not implemented; use make run hooks for your board)

lattice_sdkbuild lattice_sdkclean lattice_sdkopen:
	@true

lattice_post_build:
	$(call print,Generating lattice artifacts)
	$(OBJDUMP) --source --all-headers --demangle --line-numbers --wide $(BINARY) > $(LATTICE_LST)
	$(SIZE) --format=berkeley $(BINARY) > $(LATTICE_SIZ)
	$(OC) -O binary --gap-fill 0 $(BINARY) $(LATTICE_BIN)
	$(SREC_CAT) $(LATTICE_BIN) -Binary -byte-swap 4 -DISable Header -Output $(LATTICE_MEM) -MEM 32

lattice_project:
	$(call mk_dir,$(BUILD_DIR))
